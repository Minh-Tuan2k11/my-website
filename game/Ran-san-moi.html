<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ğŸ Ráº¯n SÄƒn Má»“i</title>
  <style>
    body {
      background-color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      color: white;
      font-family: Arial, sans-serif;
    }
    canvas {
      background-color: #111;
      border: 2px solid #0f0;
    }
    h1 {
      margin-bottom: 10px;
    }
    #startBtn, #toggleColorBtn, .skinBtn, #toggleMazeBtn, #modeToggleBtn {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #0f0;
      color: #000;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    #startBtn:hover, #toggleColorBtn:hover, .skinBtn:hover, #toggleMazeBtn:hover, #modeToggleBtn:hover {
      background-color: #0c0;
    }
    #toggleColorBtn {
      background-color: #ff0;
    }
    .skinBtnsContainer {
      display: flex;
      margin-top: 10px;
    }
    .skinBtn {
      background-color: #444;
      margin: 0 5px;
      color: white;
    }
    .skinBtn:hover {
      background-color: #555;
    }
    #message {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 24px;
      color: #fff;
      background: rgba(0,0,0,0.6);
      padding: 10px 20px;
      border-radius: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ Ráº¯n SÄƒn Má»“i</h1>
  <div id="message">HÃ£y di chuyá»ƒn Ä‘á»ƒ báº¯t Ä‘áº§u</div>
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <button id="startBtn">â–¶ Báº¯t Ä‘áº§u / ChÆ¡i láº¡i</button>
  <button id="toggleColorBtn">ğŸ”„ Báº­t/Táº¯t MÃ u Ngáº«u NhiÃªn</button>
  <button id="toggleMazeBtn">ğŸ”² Cháº¿ Äá»™ MÃª Cung</button>
  <button id="modeToggleBtn">ğŸŒ€ Cháº¿ Äá»™: TÆ°á»ng Xung Quanh</button>

  <div class="skinBtnsContainer">
    <button class="skinBtn" data-color="#0f0">Xanh lÃ¡</button>
    <button class="skinBtn" data-color="#00f">Xanh dÆ°Æ¡ng</button>
    <button class="skinBtn" data-color="#f00">Äá»</button>
    <button class="skinBtn" data-color="#ff0">VÃ ng</button>
    <button class="skinBtn" data-color="#fff">Tráº¯ng</button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");
    const toggleColorBtn = document.getElementById("toggleColorBtn");
    const toggleMazeBtn = document.getElementById("toggleMazeBtn");
    const modeToggleBtn = document.getElementById("modeToggleBtn");
    const message = document.getElementById("message");

    const gridSize = 20;
    const tileCount = canvas.width / gridSize;

    let snake = [];
    let direction = { x: 0, y: 0 };
    let food = {};
    let gameInterval;
    let score = 0;
    let randomColorEnabled = false;
    let snakeColor = "#0f0";
    let mazeMode = false;
    let wallMode = false;
    let gameStarted = false; // Äá»ƒ kiá»ƒm soÃ¡t khi ráº¯n báº¯t Ä‘áº§u di chuyá»ƒn

    // Báº£n Ä‘á»“ mÃª cung Ä‘Ã£ sá»­a (loáº¡i bá» cÃ¡c Ã´ káº¹t 1x1)
    const mazeWalls = [
      // Viá»n trong
      ...Array.from({ length: 18 }, (_, i) => ({ x: i + 1, y: 1 })),
      ...Array.from({ length: 18 }, (_, i) => ({ x: i + 1, y: 18 })),
      ...Array.from({ length: 18 }, (_, i) => ({ x: 1, y: i + 1 })),
      ...Array.from({ length: 18 }, (_, i) => ({ x: 18, y: i + 1 })),
      // ÄÆ°á»ng dá»c
      ...Array.from({ length: 10 }, (_, i) => ({ x: 5, y: i + 4 })),
      ...Array.from({ length: 10 }, (_, i) => ({ x: 14, y: i + 6 })),
      // ÄÆ°á»ng ngang
      ...Array.from({ length: 6 }, (_, i) => ({ x: i + 7, y: 8 })),
      ...Array.from({ length: 6 }, (_, i) => ({ x: i + 6, y: 13 }))
    ];

    function getRandomColor() {
      const letters = "0123456789ABCDEF";
      let color = "#";
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function draw() {
      ctx.fillStyle = "#111";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (mazeMode) drawMaze();

      moveSnake();

      snake.forEach((part, index) => {
        const color = randomColorEnabled && index > 0 ? getRandomColor() : snakeColor;
        ctx.fillStyle = color;
        ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize - 2, gridSize - 2);
      });

      ctx.fillStyle = "#f00";
      ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
    }

    function moveSnake() {
      if (!gameStarted) return; // Äá»©ng yÃªn cho Ä‘áº¿n khi ngÆ°á»i chÆ¡i báº¥m phÃ­m

      let newX = snake[0].x + direction.x;
      let newY = snake[0].y + direction.y;

      if (wallMode && (newX < 0 || newY < 0 || newX >= tileCount || newY >= tileCount)) {
        return gameOver();
      }
      if (!wallMode) {
        newX = (newX + tileCount) % tileCount;
        newY = (newY + tileCount) % tileCount;
      }

      const head = { x: newX, y: newY };

      // Kiá»ƒm tra ráº¯n cáº¯n chÃ­nh nÃ³ (bá» qua Ä‘áº§u)
      if (snake.slice(1).some(seg => seg.x === head.x && seg.y === head.y)) {
        return gameOver();
      }
      if (mazeMode && mazeWalls.some(wall => wall.x === head.x && wall.y === head.y)) {
        return gameOver();
      }

      snake.unshift(head);

      if (head.x === food.x && head.y === food.y) {
        score++;
        spawnFood();
      } else {
        snake.pop();
      }
    }

    function canReachFood(foodPos) {
  let visited = Array.from({ length: tileCount }, () => Array(tileCount).fill(false));
  let queue = [snake[0]]; // báº¯t Ä‘áº§u tá»« Ä‘áº§u ráº¯n
  visited[snake[0].y][snake[0].x] = true;

  const dirs = [
    {x:1,y:0},{x:-1,y:0},
    {x:0,y:1},{x:0,y:-1}
  ];

  while (queue.length) {
    let {x, y} = queue.shift();
    if (x === foodPos.x && y === foodPos.y) return true;

    for (let d of dirs) {
      let nx = x + d.x, ny = y + d.y;
      if (nx < 0 || ny < 0 || nx >= tileCount || ny >= tileCount) continue;
      if (visited[ny][nx]) continue;

      // KhÃ´ng Ä‘i qua thÃ¢n ráº¯n hoáº·c tÆ°á»ng
      if (snake.some(p => p.x === nx && p.y === ny)) continue;
      if (mazeMode && mazeWalls.some(w => w.x === nx && w.y === ny)) continue;

      visited[ny][nx] = true;
      queue.push({x:nx, y:ny});
    }
  }
  return false;
}

    function spawnFood() {
    let newFood;
    do {
    newFood = {
      x: Math.floor(Math.random() * tileCount),
      y: Math.floor(Math.random() * tileCount)
    };
    } while (
    snake.some(p => p.x === newFood.x && p.y === newFood.y) ||
    (mazeMode && mazeWalls.some(w => w.x === newFood.x && w.y === newFood.y)) ||
    !canReachFood(newFood) // kiá»ƒm tra cÃ³ Ä‘Æ°á»ng tá»›i tÃ¡o khÃ´ng
    );
    food = newFood;
    }

    function drawMaze() {
      ctx.fillStyle = "#888";
      mazeWalls.forEach(wall => {
        ctx.fillRect(wall.x * gridSize, wall.y * gridSize, gridSize - 2, gridSize - 2);
      });
    }

    function gameOver() {
      clearInterval(gameInterval);
      alert("ğŸª¦ Game Over! Äiá»ƒm cá»§a báº¡n: " + score);
    }

    document.addEventListener("keydown", e => {
      switch (e.key) {
        case "ArrowUp":
        case "w":
          if (direction.y === 0) direction = { x: 0, y: -1 };
          break;
        case "ArrowDown":
        case "s":
          if (direction.y === 0) direction = { x: 0, y: 1 };
          break;
        case "ArrowLeft":
        case "a":
          if (direction.x === 0) direction = { x: -1, y: 0 };
          break;
        case "ArrowRight":
        case "d":
          if (direction.x === 0) direction = { x: 1, y: 0 };
          break;
      }
      if (!gameStarted && (direction.x !== 0 || direction.y !== 0)) {
        gameStarted = true;
        message.style.display = "none";
      }
    });

    function startGame() {
      clearInterval(gameInterval);
      snake = [{ x: 10, y: 10 }];
      direction = { x: 0, y: 0 };
      score = 0;
      gameStarted = false;
      spawnFood();
      message.style.display = "block";
      gameInterval = setInterval(draw, 150);
    }

    function toggleRandomColor() {
      randomColorEnabled = !randomColorEnabled;
      toggleColorBtn.textContent = randomColorEnabled ? "ğŸ”„ Táº¯t MÃ u Ngáº«u NhiÃªn" : "ğŸ”„ Báº­t MÃ u Ngáº«u NhiÃªn";
    }

    function chooseSkin(event) {
      snakeColor = event.target.getAttribute("data-color");
    }

    function toggleMaze() {
      mazeMode = !mazeMode;
      toggleMazeBtn.textContent = mazeMode ? "ğŸ”² Táº¯t MÃª Cung" : "ğŸ”² Báº­t MÃª Cung";
      if (mazeMode) {
        wallMode = false;
        modeToggleBtn.textContent = "ğŸŒ€ Cháº¿ Äá»™: TÆ°á»ng Xung Quanh";
      }
    }

    function toggleMode() {
      if (mazeMode) return;
      wallMode = !wallMode;
      modeToggleBtn.textContent = wallMode ? "ğŸŒ€ Cháº¿ Äá»™: TÆ°á»ng Xung Quanh" : "ğŸŒ€ Cháº¿ Äá»™: Äi XuyÃªn TÆ°á»ng";
    }

    startBtn.addEventListener("click", startGame);
    toggleColorBtn.addEventListener("click", toggleRandomColor);
    toggleMazeBtn.addEventListener("click", toggleMaze);
    modeToggleBtn.addEventListener("click", toggleMode);

    document.querySelectorAll(".skinBtn").forEach(btn => {
      btn.addEventListener("click", chooseSkin);
    });

    draw();
  </script>
</body>
</html>